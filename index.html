<html ng-app="DOECaptainsApp">
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-cookies.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.2.4/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/angularfire/1.1.2/angularfire.min.js"></script>
    <script>
    //http://papermashup.com/read-url-get-variables-withjavascript/
    function getUrlVars() {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
        vars[key] = value;
      });
      return vars;
    }
    
    //https://www.firebase.com/docs/web/libraries/angular/quickstart.html
    var app = angular.module("DOECaptainsApp", ["firebase","ngCookies"]);
    
    app.factory("Round", ["$firebaseObject",
      function($firebaseObject) {
        return function(id) {
          // create a reference to the database where we will store our data
          var randomRoomId = Math.round(Math.random() * 100000000);
          var rounds = new Firebase("https://doecaptains.firebaseio.com/rounds");
          var rounddata;
          if(id !== undefined)
            rounddata = rounds.child(id);
          else
            rounddata = rounds.push();
          
          // return it as a synchronized object
          return $firebaseObject(rounddata);
        }
      }
    ]);
    
    app.controller("DOECaptainsController", ["$scope", "Round", "$firebaseArray",
      function($scope, Round, $firebaseArray) {
        var rounds = new Firebase("https://doecaptains.firebaseio.com/rounds");
        $scope.availableRounds = $firebaseArray(rounds);
        $scope.unbindRound = function(){};
        
        if(getUrlVars().hasOwnProperty("roundID"))
          $scope.loadRound(getUrlVars()["roundID"]);
        
        $scope.loadRound = function(roundID){
          $scope.unbindRound();
          if(roundID!==undefined && roundID!=="")
            $scope.roundID = roundID;
          if($scope.roundID!==undefined && $scope.roundID!==""){
            Round($scope.roundID).$bindTo($scope,"round").then(function(unbind){
              $scope.unbindRound = unbind;
            });
          }
          else{
            Round().$bindTo($scope,"round").then(function(unbind){
              $scope.roundID = $scope.round.$id;
              $scope.round = $scope.blankround();
              $scope.round.$id = $scope.roundID;
              $scope.unbindRound = unbind;
            });
          }
        };
        
        $scope.blankplayer = function(){return {pos:"Player",name:"Someone"};};
        $scope.blankteam = function(){return {name:"Team X",players:[$scope.blankplayer()]};};
        $scope.blankquestion = function(){return {};};
        $scope.blankround = function(){return {
          name:"Unnamed Round",
          date:"[MM/DD/YY]",
          round:"Some Round From Somewhere Of Some Year",
          detail:"",
          teams: [$scope.blankteam,$scope.blankteam],
          questions:[],
        }};
        
        $scope.reset = function(){
          if(confirm("Are you sure you want to clear everything about this round?")){
            $scope.round.teams = [];
            $scope.round.questions = [];
            return true;
          }
          else return false;
        };
        
        $scope.regularroundteams = [ //Should never edit indices... change this.
          {
            name: "Team 1",
            players:[
              {pos:"Player 1",name:"Someone"},
              {pos:"Captain",name:"Someone"},
              {pos:"Player 2",name:"Someone"},
              {pos:"Player 3",name:"Someone"},
              {pos:"Player 4",name:"Someone"},
            ],
          },
          {
            name: "Team 2",
            players:[
              {pos:"Player 1",name:"Someone"},
              {pos:"Captain",name:"Someone"},
              {pos:"Player 2",name:"Someone"},
              {pos:"Player 3",name:"Someone"},
              {pos:"Player 4",name:"Someone"},
            ],
          },
        ];
        $scope.speedroundteams = [
          {
            name: "Team 1",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 2",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 3",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 4",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 5",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 6",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 7",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 8",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 9",
            players:[{pos:"Player",name:"Someone"}],
          },
          {
            name: "Team 10",
            players:[{pos:"Player",name:"Someone"}],
          },
        ];
        $scope.members = $firebaseArray(new Firebase("https://doecaptains.firebaseio.com/members"));
      }
    ]);
    </script>
    <style>
      table{width:100%;text-align:center;}
      td{background-color:#ccc;padding:2em;}
      td.mid{width:5px;background-color:black;padding:0;}
      td b{font-size:2em;}
      td.buzzed{background-color:#ffc;}
      td.correct{background-color:#ffc;}
      td.incorrect{background-color:#ffc;}
      
      .teamname{font-size: 1.3em; font-weight: bold; margin-top: 1em;}
      .playerpos{font-weight: bold; display: inline;}
    </style>
  </head>
  <body ng-controller="DOECaptainsController as dq">
    <div id="round">
      <h2>Round</h2>
      <div><select ng-model="roundID" ng-options="round.$id as round.name for round in availableRounds"><option value="">NEW ROUND</option></select><button ng-click="loadRound()">Load Round</button></div>
      <br><br>
      <div ng-show="round !== undefined" class=".ng-hide">
        <div><b>ID:</b> <span ng-bind="round.$id">LOADING . . . . .</span></div>
        <div><b>Round Name:</b> <input ng-model="round.name"/></div>
        <div><b>Date:</b> <input ng-model="round.date"/></div>
        <div><b>Which Round Read:</b> <input ng-model="round.round"></div>
        <div><b>Additional Details?</b> <br><textarea ng-model="round.details"></textarea></div>
        <div>
          <h2>Teams</h2>
          <div>
            <button ng-click="reset() && (round.teams = regularroundteams)">Set up Blank Regular Round</button>
            <button ng-click="reset() && (round.teams = speedroundteams)">Set up Blank Speed Round</button>
          </div>
          <div ng-repeat="team in round.teams track by $index">
            <input ng-model="team.name" class="teamname" />
            <div ng-repeat="(ind,player) in team.players track by $index">
              <input ng-model="player.pos" class="playerpos" />:
              <select ng-model="player.name" ng-options="memberdata.name as memberdata.name for memberdata in members track by $index"><option></option></select>
              <button ng-click="team.players.splice(ind,1)">x</button>
            </div>
            <button ng-click="team.players.push(blankplayer())">+</button>
          </div>
        </div>
        <br><button ng-click="round.teams.push(blankteam())">Add Team</button>
        <div id="qhistorydisplay">
          <h2>Questions</h2>
          <!--Here is an editable display of all the questions that have been read so far. Who(s) buzzed, what they(s) did, bonus, etc. -->
          <!--Though we love the new input system, you will always be able to enter data this way too. 
          THE NEW INPUT SYSTEM SHOULD JUST BE A LAYER OVER THIS DROPDOWN-BOX SYSTEM.-->
          <div ng-repeat="(ind,question) in round.questions">
            TOSS-UP
            <select ng-model="question.subject"><option value="" selected>SUBJECT?</option><option>BIO</option><option>CHEM</option><option>PHYS</option><option>MATH</option><option>ESS</option></select>:
            <select ng-model="question.buzz1.who"><option value="" selected>BUZZ 1?</option><optgroup ng-repeat="team in round.teams" label="{{team.name}}"><option ng-repeat="player in team.players">{{player.name}}</option></optgroup></select>
            <select ng-model="question.buzz1.interrupt"><option value="" selected>INTERRUPT?</option><option>Interrupt</option><option>Regular</option></select>
            <select ng-model="question.buzz1.response"><option value="" selected>RESPONSE?</option><option>Correct</option><option>Incorrect</option><option>Blurt</option><option>Stall</option></select>
            <span ng-show="question.buzz1.response === 'Incorrect' || question.buzz1.response === 'Blurt' || question.buzz1.response === 'Stall'">
              <select ng-model="question.buzz2.who"><option value="" selected>BUZZ 2?</option><optgroup ng-repeat="team in round.teams" label="{{team.name}}"><option ng-repeat="player in team.players">{{player.name}}</option></optgroup></select>
              <select ng-model="question.buzz2.interrupt"><option value="" selected>INTERRUPT?</option><option>Interrupt</option><option>Regular</option></select>
              <select ng-model="question.buzz2.response"><option value="" selected>RESPONSE?</option><option>Correct</option><option>Incorrect</option><option>Blurt</option><option>Stall</option></select>
            </span>
            <select ng-model="question.bonus" ng-show="question.buzz1.response==='Correct' || question.buzz2.response==='Correct'"><option value="" selected>BONUS?</option><option>Correct</option><option>Incorrect</option></select>
            <button ng-click="round.questions.splice(ind,1)">x</button>
          </div>
          <button ng-click="round.questions.push(blankquestion())">New Question</button>
        </div>
      </div>
    </div>
    <div id="teamdisplay">
    </div>

    <!--script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script-->
<script>
/*
    //Use JSON cookie storage. https://github.com/samyk/evercookie :D
    //And always be sending stuff back to the server, every question and every direct-edit.


    //backspace goes back
    //5v5 for normal and freeforall mode for speed rounds (don't bother with the complex stuff)
    n1 vs n2 vs n3 vs n4 vs ... vs nm


    var keyBindings = {};
    function bindKeyToPlayer(key, player){
      keyBindings[key] = player;
    }
    $(window).keypress(function(e){
      if(e.which == 32);
      else if(e.which == 13);
      else{
        var ch = String.fromCharCode(e.which);
      }
    });

    function Player(){
      
    }
    function Team(name,players){
      this.name = name;
      this.points = 0;
      this.players = players;
      this.buzzingAllowed = true;
      this.reset = function(){
        this.buzzingAllowed = true;
        
      };
      this.buzz = function(key){
        for(var i = 0; i < players.length; i++)
          if(players[i].key == key)return i;
        return -1;
      };
    }

    var NormalGame = { //Point values and everything should be here
      "start": function(key){
        if(key=="space")return "tossup";
        else return false;
      },
      "tossup": function(key){
        //key will be a s d f j k l ;
      },
      "interrupting": function(key){
        for(var i = 0; i < teams.length; i++){
          var index = teams[i].buzz(key);
          if(index !== -1)
            1;
        }
      },
      "regular buzzing": function(key){
      
      },
    };


    var teams = [
      new Team("A Team",[
        {
          person:{
            id:123,
            name:"Aiyappa Kodendera",
          },
          key:"a",
          title:"Player 3",
        },
        {
          person:{
            id:41,
            name:"Catherine Wang",
          },
          key:"s",
          title:"Player 2",
        },
        {
          person:{
            id:443,
            name:"Eric Xia",
          },
          key:"d",
          title:"Captain",
        },
        {
          person:{
            id:0,
            name:"Clive Chan",
          },
          key:"f",
          title:"Player 1",
        },
      ]),
      new Team("B Team",[
        {
          person:{
            id:723,
            name:"AK",
          },
          key:"a",
          title:"Player 1",
        },
        {
          person:{
            id:552,
            name:"CW",
          },
          key:"s",
          title:"Captain",
        },
        {
          person:{
            id:989,
            name:"EX",
          },
          key:"d",
          title:"Player 2",
        },
        {
          person:{
            id:34,
            name:"CC",
          },
          key:"f",
          title:"Player 3",
        },
      ]),
    ];

    //for()
    $("#buttons");

    //var buzzesAllowed
    //freeForAll?
    //var positions = ["Player 1","Captain","Player 2","Player 3","Player 4"];
    //var teams = ["gfdsa","hjkl;"]; //Standard 5v5 - indices correspond with var positions
    //var teams = ["a","s","d","f","g","h","j","k","l",";"];
    var maintable = $(".team");
    (function(){
      for(var t = 0; t < teams.length; t++){
        if(t%2 == 0){
          var row = document.createElement("tr");
          for(var i = teams[t].length - 1; i >= 0; i--){
            var player = document.createElement("td");
            player.innerHTML = "<b>"+teams[t][i]+"</b><br>"+positions[i];
            player.id = "t"+t+"p"+i;
            row.appendChild(player);
          }
          maintable.append(row);
        }
        else{
          var rows = maintable.find("tr");
          var row = rows[rows.length-1];
          var mid = document.createElement("td");
          mid.className="mid";
          row.appendChild(mid);
          for(var i = 0; i < teams[t].length; i++){
            var player = document.createElement("td");
            player.innerHTML = "<b>"+teams[t][i]+"</b><br>"+positions[i];
            player.id = "t"+t+"p"+i;
            row.appendChild(player);
          }
        }
      }
    })();
    window.onkeypress=function(e){
      if(!e)var e=window.event;
      if(e.keyCode == 32){//space resets
        buzzed = false;
        document.getElementsByClassName("buzzed")[0].className="";
      }
      console.log(e);
      if(buzzed === true){
        if(e.keyCode == 13){
          
        }
      }
      if(buzzed === false){
        for(var t = 0; t < teams.length; t++)
          for(var i = 0; i < teams[t].length; i++)
            if(e.keyCode == teams[t].charCodeAt(i)){
              console.log("Team "+(t+1)+", "+positions[i]);
              document.getElementById("t"+t+"p"+i).className = "buzzed";
              buzzed = true;
            }
      }
    }*/
    </script>
  </body>
</html>